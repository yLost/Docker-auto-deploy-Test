name: CI

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Docker Deployment
        # You may pin to the exact commit or the version.
        # uses: wshihadeh/docker-deployment-action@e11d221fc27fa0aca5bdd09b8d17f816c55d6705
        uses: wshihadeh/docker-deployment-action@v2
        with:
          # Remote Docker host ie (user@host)
          remote_docker_host: ${{secrets.DOCKER_SSH_HOST}}
          # Remote Docker SSH public key
          ssh_public_key: ${{secrets.DOCKER_SSH_PUBLIC_KEY}}
          # SSH private key used to connect to the docker host
          ssh_private_key: ${{secrets.DOCKER_SSH_PRIVATE_KEY}}
          deployment_mode: docker-compose
          args: |
            up -d
            docker stack deploy --compose-file docker-compose.yaml --log-level debug --host ${{secrets.DOCKER_SSH_HOST}}
          pre_deployment_command_args: 'bundle exec rake db:migrate'
          docker_prune: 'true'
          pull_images_first: 'true'
          deploy_path: /home/docker/DockerAutoDeployTest
          stack_file_name: docker-compose.yaml
